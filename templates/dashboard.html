<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard E2EE Secure</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .user-list { width: 250px; border-right: 1px solid #ccc; }
        .chat-area { flex: 1; }
        .message-box { height: 300px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .msg.received { background: #e2e2e2; }
        .msg.sent { background: #dcf8c6; text-align: right; }
        .meta { font-size: 0.7em; color: #555; display: block; margin-top: 3px;}
        .verified { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Halo, {{ current_user }}</h1>
    <a href="/logout">Logout</a>
    <hr>

    <div class="container">
        <div class="user-list">
            <h3>User Lain</h3>
            <select id="recipientSelect">
                <option value="">Pilih User...</option>
                {% for user in users %}
                <option value="{{ user }}">{{ user }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="chat-area">
            <h3>Chat Aman (Signed & Encrypted)</h3>
            <div id="messageBox" class="message-box"></div>
            <textarea id="msgInput" style="width: 100%;" placeholder="Ketik pesan..."></textarea>
            <br><br>
            <button onclick="sendMessage()">Kirim Pesan</button>
        </div>
    </div>

    <script>
        const currentUser = "{{ current_user }}";

        function str2ab(str) {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        function ab2str(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // --- ambil keys  ---

        async function loadMyPrivateKey(type) {
            // type: 'enc' atau 'sign'
            const keyStr = localStorage.getItem(type + '_priv_key_' + currentUser);
            if (!keyStr) return null;

            const algo = (type === 'enc') ? 
                { name: "RSA-OAEP", hash: "SHA-256" } : 
                { name: "RSA-PSS", hash: "SHA-256" };
            
            const usage = (type === 'enc') ? ["decrypt"] : ["sign"];

            return await window.crypto.subtle.importKey(
                "pkcs8",
                str2ab(atob(keyStr)),
                algo,
                true,
                usage
            );
        }

        async function getUserKeys(username) {
            const res = await fetch(`/api/get_public_key/${username}`);
            const data = await res.json();
            if(data.status !== 'ok') return null;
            return data;
        }

        async function importPublicKey(pem, type) {
            const algo = (type === 'enc') ? 
                { name: "RSA-OAEP", hash: "SHA-256" } : 
                { name: "RSA-PSS", hash: "SHA-256" };
            
            const usage = (type === 'enc') ? ["encrypt"] : ["verify"];

            return await window.crypto.subtle.importKey(
                "spki",
                str2ab(atob(pem)),
                algo,
                true,
                usage
            );
        }

        // --- kirim pesan ---

        async function sendMessage() {
            const recipient = document.getElementById('recipientSelect').value;
            const text = document.getElementById('msgInput').value;
            
            if (!recipient || !text) return alert("Pilih penerima dan isi pesan.");

            try {
                // 1. cari kunci
                const recipientKeys = await getUserKeys(recipient);
                if (!recipientKeys) return alert("User tidak ditemukan.");
                
                const encPubKey = await importPublicKey(recipientKeys.public_key, 'enc');
                const mySignPrivKey = await loadMyPrivateKey('sign');

                if (!mySignPrivKey) return alert("Kunci tanda tangan Anda hilang. Silakan login ulang/clear cache.");

                // 2. enkripsi pesan
                const encodedText = new TextEncoder().encode(text);
                const encryptedData = await window.crypto.subtle.encrypt(
                    { name: "RSA-OAEP" },
                    encPubKey,
                    encodedText
                );
                const encryptedBase64 = arrayBufferToBase64(encryptedData);

                // 3. buat hash (sha-256)
                const msgHashBuffer = await window.crypto.subtle.digest("SHA-256", encryptedData);
                const msgHashBase64 = arrayBufferToBase64(msgHashBuffer);

                // 4. tanda tangan hash
                const signatureBuffer = await window.crypto.subtle.sign(
                    {
                        name: "RSA-PSS",
                        saltLength: 32,
                    },
                    mySignPrivKey,
                    msgHashBuffer 
                );
                const signatureBase64 = arrayBufferToBase64(signatureBuffer);

                // 5. kirim ke server
                const payload = {
                    recipient: recipient,
                    content: encryptedBase64,
                    msg_hash: msgHashBase64,
                    signature: signatureBase64
                };

                await fetch('/api/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Update UI
                const box = document.getElementById('messageBox');
                box.innerHTML += `<div class="msg sent"><b>Saya:</b> ${text} <br><span class="meta">Hash: ${msgHashBase64.substring(0,10)}...</span></div>`;
                document.getElementById('msgInput').value = '';

            } catch (err) {
                console.error(err);
                alert("Gagal mengirim pesan: " + err.message);
            }
        }

        // --- menerima pesan ---

        async function fetchMessages() {
            const myEncPrivKey = await loadMyPrivateKey('enc');
            if (!myEncPrivKey) return;

            const res = await fetch('/api/get_messages');
            const data = await res.json();

            const box = document.getElementById('messageBox');
            box.innerHTML = ''; 

            for (let msg of data.messages) {
                let decryptedText = "(Gagal dekripsi)";
                let verifiedStatus = "(Tanda tangan tidak valid)";
                let styleColor = "red";

                try {
                    // 1. Ambil Kunci Signing Pengirim untuk verifikasi
                    const senderKeys = await getUserKeys(msg.sender);
                    const senderSignPubKey = await importPublicKey(senderKeys.signing_public_key, 'sign');

                    // 2. Verifikasi Hash & Tanda Tangan
                    const encryptedBuffer = str2ab(atob(msg.content));
                    const signatureBuffer = str2ab(atob(msg.signature));
                    
                    // Hitung ulang hash dari pesan yang diterima
                    const computedHashBuffer = await window.crypto.subtle.digest("SHA-256", encryptedBuffer);
                    
                    // Verifikasi tanda tangan terhadap hash tersebut
                    const isValid = await window.crypto.subtle.verify(
                        { name: "RSA-PSS", saltLength: 32 },
                        senderSignPubKey,
                        signatureBuffer,
                        computedHashBuffer
                    );

                    if (isValid) {
                        verifiedStatus = "Terverifikasi";
                        styleColor = "green";
                    } else {
                        verifiedStatus = "TANDA TANGAN PALSU";
                    }

                    // 3. Dekripsi Pesan
                    const decryptedData = await window.crypto.subtle.decrypt(
                        { name: "RSA-OAEP" },
                        myEncPrivKey,
                        encryptedBuffer
                    );
                    decryptedText = new TextDecoder().decode(decryptedData);

                } catch (e) {
                    console.error(e);
                }

                box.innerHTML += `
                    <div class="msg received">
                        <b>${msg.sender}:</b> ${decryptedText} <br>
                        <span class="meta" style="color:${styleColor}">${verifiedStatus}</span>
                        <span class="meta">Hash: ${msg.msg_hash.substring(0,10)}...</span>
                    </div>`;
            }
        }

        setInterval(fetchMessages, 5000);
    </script>
</body>
</html>